<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>第十六章：服务发现实现 —— consul | 丢哥</title><meta name=keywords content><meta name=description content="上一章我们介绍了服务发现的具体原理以及技术选型，本章我们将从代码实现的角度来介绍下如何使用 consul 来进行框架服务发现支持。
一、consul 介绍
关于 consul 的介绍，最直接的可以参考官方 github 仓库 consul，或者直接参考 consul 官网 www.consul.io 。这里我们只介绍最基础的环境安装和 quick start"><meta name=author content="丢哥"><link rel=canonical href=https://diu.life/lessons/go-rpc/service-discovery-implementation/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://diu.life/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://diu.life/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://diu.life/favicon-32x32.png><link rel=apple-touch-icon href=https://diu.life/apple-touch-icon.png><link rel=mask-icon href=https://diu.life/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://diu.life/lessons/go-rpc/service-discovery-implementation/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2499390968830075" crossorigin=anonymous></script><meta property="og:url" content="https://diu.life/lessons/go-rpc/service-discovery-implementation/"><meta property="og:site_name" content="丢哥"><meta property="og:title" content="第十六章：服务发现实现 —— consul"><meta property="og:description" content="上一章我们介绍了服务发现的具体原理以及技术选型，本章我们将从代码实现的角度来介绍下如何使用 consul 来进行框架服务发现支持。
一、consul 介绍 关于 consul 的介绍，最直接的可以参考官方 github 仓库 consul，或者直接参考 consul 官网 www.consul.io 。这里我们只介绍最基础的环境安装和 quick start"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="lessons"><meta property="article:published_time" content="2020-02-16T00:00:00+08:00"><meta property="article:modified_time" content="2020-02-16T00:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="第十六章：服务发现实现 —— consul"><meta name=twitter:description content="上一章我们介绍了服务发现的具体原理以及技术选型，本章我们将从代码实现的角度来介绍下如何使用 consul 来进行框架服务发现支持。
一、consul 介绍
关于 consul 的介绍，最直接的可以参考官方 github 仓库 consul，或者直接参考 consul 官网 www.consul.io 。这里我们只介绍最基础的环境安装和 quick start"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"教程","item":"https://diu.life/lessons/"},{"@type":"ListItem","position":2,"name":"从 0 到 1 开发一款高性能 RPC 框架","item":"https://diu.life/lessons/go-rpc/"},{"@type":"ListItem","position":3,"name":"第十六章：服务发现实现 —— consul","item":"https://diu.life/lessons/go-rpc/service-discovery-implementation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"第十六章：服务发现实现 —— consul","name":"第十六章：服务发现实现 —— consul","description":"上一章我们介绍了服务发现的具体原理以及技术选型，本章我们将从代码实现的角度来介绍下如何使用 consul 来进行框架服务发现支持。\n一、consul 介绍 关于 consul 的介绍，最直接的可以参考官方 github 仓库 consul，或者直接参考 consul 官网 www.consul.io 。这里我们只介绍最基础的环境安装和 quick start\n","keywords":[],"articleBody":"上一章我们介绍了服务发现的具体原理以及技术选型，本章我们将从代码实现的角度来介绍下如何使用 consul 来进行框架服务发现支持。\n一、consul 介绍 关于 consul 的介绍，最直接的可以参考官方 github 仓库 consul，或者直接参考 consul 官网 www.consul.io 。这里我们只介绍最基础的环境安装和 quick start\n1、consul 安装 进入官网 www.consul.io/downloads.h… 下载 consul，假如是 mac 系统也可以使用 brew 安装。\nbrew install consul 验证是否安装成功，打开一个命令行工具，输入 consul 命令，如下：\nDEVLINTANG-MB0:Documents delvin$ consul Usage: consul [--version] [--help] \u003ccommand\u003e [\u003cargs\u003e] Available commands are: acl Interact with Consul's ACLs agent Runs a Consul agent catalog Interact with the catalog config Interact with Consul's Centralized Configurations connect Interact with Consul Connect debug Records a debugging archive for operators event Fire a new event exec Executes a command on Consul nodes force-leave Forces a member of the cluster to enter the \"left\" state info Provides debugging information for operators. intention Interact with Connect service intentions join Tell Consul agent to join cluster keygen Generates a new encryption key keyring Manages gossip layer encryption keys kv Interact with the key-value store leave Gracefully leaves the Consul cluster and shuts down lock Execute a command holding a lock login Login to Consul using an auth method logout Destroy a Consul token created with login maint Controls node or service maintenance mode members Lists the members of a Consul cluster monitor Stream logs from a Consul agent operator Provides cluster-level tools for Consul operators reload Triggers the agent to reload configuration files rtt Estimates network round trip time between nodes services Interact with services snapshot Saves, restores and inspects snapshots of Consul server state tls Builtin helpers for creating CAs and certificates validate Validate config files/directories version Prints the Consul version watch Watch for changes in Consul 假如出现上面的指令列表，则说明 consul 安装成功。\n2、consul 的运行 完成 consul 的安装后，就可以开始运行 agent，agent 可以运行为 server 或者 client 模式。每个数据中心必须至少拥有一个 server。一般建议在一个集群中部署 3~5 个 server，避免出现单点故障导致数据丢失。\n假如 consul agent 的 client 模式，表现为一个非常轻量级的进程，用于注册服务、运行健康检查和转发对 server 的查询。\n在 consul agent 的 client 模式下，所有注册到当前节点的服务会被转发到 server，本身是不持久化这些信息。在 consul agent 的 server 模式下，功能和 client 模式一样，唯一不同的是，它会把所有的信息持久化的本地，这样遇到故障，信息是可以被保留的。\n快速启动一个单点的 consul，我们可以运行\nconsul agent -dev 执行这个命令会输出一些日志，如下：\nDEVLINTANG-MB0:Documents delvin$ consul agent -dev ==\u003e Starting Consul agent... Version: 'v1.6.2' Node ID: '15993850-f9f0-1e07-08d0-7a27723c178b' Node name: 'DEVLINTANG-MB0' Datacenter: 'dc1' (Segment: '') Server: true (Bootstrap: false) Client Addr: [127.0.0.1] (HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600) Cluster Addr: 127.0.0.1 (LAN: 8301, WAN: 8302) Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false, Auto-Encrypt-TLS: false ==\u003e Log data will now stream in as it occurs: 2020/04/06 18:00:33 [DEBUG] agent: Using random ID \"15993850-f9f0-1e07-08d0-7a27723c178b\" as node ID 2020/04/06 18:00:33 [DEBUG] tlsutil: Update with version 1 2020/04/06 18:00:33 [DEBUG] tlsutil: OutgoingRPCWrapper with version 1 2020/04/06 18:00:33 [INFO] raft: Initial configuration (index=1): [{Suffrage:Voter ID:15993850-f9f0-1e07-08d0-7a27723c178b Address:127.0.0.1:8300}] 2020/04/06 18:00:33 [INFO] raft: Node at 127.0.0.1:8300 [Follower] entering Follower state (Leader: \"\") 2020/04/06 18:00:33 [INFO] serf: EventMemberJoin: DEVLINTANG-MB0.dc1 127.0.0.1 2020/04/06 18:00:33 [INFO] serf: EventMemberJoin: DEVLINTANG-MB0 127.0.0.1 2020/04/06 18:00:33 [INFO] consul: Adding LAN server DEVLINTANG-MB0 (Addr: tcp/127.0.0.1:8300) (DC: dc1) 2020/04/06 18:00:33 [INFO] consul: Handled member-join event for server \"DEVLINTANG-MB0.dc1\" in area \"wan\" 2020/04/06 18:00:33 [INFO] agent: Started DNS server 127.0.0.1:8600 (udp) 2020/04/06 18:00:33 [INFO] agent: Started DNS server 127.0.0.1:8600 (tcp) 2020/04/06 18:00:33 [INFO] agent: Started HTTP server on 127.0.0.1:8500 (tcp) 2020/04/06 18:00:33 [INFO] agent: Started gRPC server on 127.0.0.1:8502 (tcp) 2020/04/06 18:00:33 [INFO] agent: started state syncer ==\u003e Consul agent running! 2020/04/06 18:00:33 [WARN] raft: Heartbeat timeout from \"\" reached, starting election 2020/04/06 18:00:33 [INFO] raft: Node at 127.0.0.1:8300 [Candidate] entering Candidate state in term 2 2020/04/06 18:00:33 [DEBUG] raft: Votes needed: 1 2020/04/06 18:00:33 [DEBUG] raft: Vote granted from 15993850-f9f0-1e07-08d0-7a27723c178b in term 2. Tally: 1 2020/04/06 18:00:33 [INFO] raft: Election won. Tally: 1 2020/04/06 18:00:33 [INFO] raft: Node at 127.0.0.1:8300 [Leader] entering Leader state 2020/04/06 18:00:33 [INFO] consul: cluster leadership acquired 2020/04/06 18:00:33 [INFO] consul: New leader elected: DEVLINTANG-MB0 2020/04/06 18:00:33 [INFO] connect: initialized primary datacenter CA with provider \"consul\" 2020/04/06 18:00:33 [DEBUG] consul: Skipping self join check for \"DEVLINTANG-MB0\" since the cluster is too small 2020/04/06 18:00:33 [INFO] consul: member 'DEVLINTANG-MB0' joined, marking health alive 2020/04/06 18:00:34 [DEBUG] agent: Skipping remote check \"serfHealth\" since it is managed automatically 2020/04/06 18:00:34 [INFO] agent: Synced node info 2020/04/06 18:00:35 [DEBUG] tlsutil: OutgoingRPCWrapper with version 1 2020/04/06 18:00:36 [DEBUG] agent: Skipping remote check \"serfHealth\" since it is managed automatically 2020/04/06 18:00:36 [DEBUG] agent: Node info in sync 2020/04/06 18:00:36 [DEBUG] agent: Node info in sync -dev 这个参数是创建一个开发环境的 server 节点。该参数配置下，不会有任何持久化操作，即不会有任何数据写入到磁盘，所以它不能用于生产环境。\n仔细看下面这一段信息：\n2020/04/06 18:00:33 [INFO] agent: Started DNS server 127.0.0.1:8600 (udp) 2020/04/06 18:00:33 [INFO] agent: Started DNS server 127.0.0.1:8600 (tcp) 2020/04/06 18:00:33 [INFO] agent: Started HTTP server on 127.0.0.1:8500 (tcp) 2020/04/06 18:00:33 [INFO] agent: Started gRPC server on 127.0.0.1:8502 (tcp) 2020/04/06 18:00:33 [INFO] agent: started state syncer 可以看到 consul 启动了 DNS 、HTTP、gRPC 三个 server 来分别监听不同协议的请求。由于我们的实现是会采用 HTTP 协议通信，所以将会去请求 127.0.0.1:8500 这个地址。\n我们可以执行下面命令来查看这个节点的信息：\nconsul members 显示的信息如下：\nNode Address Status Type Build Protocol DC Segment DEVLINTANG-MB0 127.0.0.1:8301 alive server 1.6.2 2 dc1 可以看到，consul agent -dev 这条命令创建了一个 server 类型的节点。\n三、实现思路 上面对 consul 做了简单的介绍。要基于 consul 实现服务发现，我们首先需要明确实现思路。\n1、服务什么时候注册？ 服务注册，框架在 Server 中提供了注册 Service 的 Register 方法。Register 中会将一个或多个 Service 添加到一个 Server 中。此时，这个 Service 应该去向 consul server 发起注册，consul 会将 Service 的服务名和服务地址保存在一个 k-v 存储中。与 consul 的通信有 DNS、HTTP、gRPC 三种协议，我们采取通用的 HTTP 协议实现。\n2、服务发现怎么实现？ 因为我们采用的是客户端服务发现的模式，所以由 client 去请求 consul server，根据某个 Service 的服务名，去 consul 的 k-v 存储中获取到服务的地址。通信的方式也是 HTTP 协议。\n3、consul 如何初始化？ 这里由于引入了 consul，要想使用 consul 提供的服务发现能力，我们在启动 Server 之前，要先进行 consul 的初始化，启动 consul 服务，这样才能保证 consul 能够接收我们的服务注册、服务发现的请求。\n关于 consul 的初始化过程，我们将其统一放在插件初始化过程中去实现。这符合框架的插件化、可插拔的思想。\n四、具体实现 明确了实现思路，接下来我们就开始代码实现。\n首先，上面说到了，consul 是以插件的形式去实现，也就是在 plugin 目录下。\n1、定义 consul consul 定义如下，由于 consul 是一个独立的服务，所以它有自己的一套配置，我们在 Consul 的定义里面加上了一些 consul 配置的属性。\n// Consul implements the server discovery specification type Consul struct { opts *plugin.Options client *api.Client config *api.Config balancerName string // load balancing mode, including random, polling, weighted polling, consistent hash, etc writeOptions *api.WriteOptions queryOptions *api.QueryOptions } 2、实现 Selector 由于 consul 是服务发现组件，所以它需要实现服务发现的统一接口 Selector，也就是 Select 函数，如下：\n// implements selector Select method func (c *Consul) Select(serviceName string) (string, error) { nodes, err := c.Resolve(serviceName) if nodes == nil || len(nodes) == 0 || err != nil { return \"\", err } balancer := selector.GetBalancer(c.balancerName) node := balancer.Balance(serviceName,nodes) if node == nil { return \"\", fmt.Errorf(\"no services find in %s\", serviceName) } return parseAddrFromNode(node) } Select 就分为两步了，第一步 Resolve 方法其实就是服务发现的过程，Balance 是负载均衡实现。这里后续会介绍，这里我们聚焦于服务发现，也就是 Resolve 这个方法，看看它是怎么去实现服务发现的。\nfunc (c *Consul) Resolve(serviceName string) ([]*selector.Node, error) { pairs, _, err := c.client.KV().List(serviceName, nil) if err != nil { return nil, err } if len(pairs) == 0 { return nil, fmt.Errorf(\"no services find in path : %s\", serviceName) } var nodes []*selector.Node for _, pair := range pairs { nodes = append(nodes, \u0026selector.Node { Key : pair.Key, Value : pair.Value, }) } return nodes, nil } 可以看到，Resolve 这个方法是通过一个服务名去获取服务列表。它的核心是调用了 c.client.KV().List(serviceName, nil) 这个方法，这里 c 是 Consul 对象，client 是 *api.Client，其实这里我们是通过 consul 的 api 去与 consul 进行通信，具体 api 是通过引用 github.com/hashicorp/consul/api 这个包进行实现，具体可以参考：consul api 。通过 api KV 的 List 方法，从 consul k-v 存储中获取服务列表。\n3、实现 Plugin 由于 consul 是以插件化的形式实现的，所以我们同样也需要实现插件的通用接口 Plugin。这里由于服务发现插件和 tracing 的插件都有其个性化配置，导致其初始化方法的结构不一样，所以细化了一下 Plugin 接口，分为 ResolverPlugin 和 TracingPlugin 两类，如下：\n// ResolverPlugin defines the standard for all server discovery plug-ins type ResolverPlugin interface { Init(...Option) error } // TracingPlugin defines the standard for all tracing plug-ins type TracingPlugin interface { Init(...Option) (opentracing.Tracer, error) } 这里我们需要去实现 ResolverPlugin 这个接口，如下：\nfunc (c *Consul) Init(opts ...plugin.Option) error { for _, o := range opts { o(c.opts) } if len(c.opts.Services) == 0 || c.opts.SvrAddr == \"\" || c.opts.SelectorSvrAddr == \"\" { return fmt.Errorf(\"consul init error, len(services) : %d, svrAddr : %s, selectorSvrAddr : %s\", len(c.opts.Services), c.opts.SvrAddr, c.opts.SelectorSvrAddr) } if err := c.InitConfig(); err != nil { return err } for _, serviceName := range c.opts.Services { nodeName := fmt.Sprintf(\"%s/%s\", serviceName, c.opts.SvrAddr) kvPair := \u0026api.KVPair{ Key : nodeName, Value : []byte(c.opts.SvrAddr), Flags: api.LockFlagValue, } if _, err := c.client.KV().Put(kvPair, c.writeOptions); err != nil { return err } } return nil } 前面我们说到了，Server 启动的时候需要将 Service 去 consul 上进行注册，这个方法实现了服务注册的过程。想将服务名和服务地址包装秤 KVPair 的形式，然后通过调用 consul api 的 Put 方法进行的将 KVPair 同步到 consul 的 k-v 存储。\n4、服务初始化过程 上面说到了 Init(opts …plugin.Option) 这个方法实现了服务初始化。那么它什么时候被调用呢？\n其实就是在服务启动之前，其实就是在 Serve() 这个方法里面，我们来看：\nfunc (s *Server) Serve() { err := s.InitPlugins() if err != nil { panic(err) } for _, service := range s.services { go service.Serve(s.opts) } ch := make(chan os.Signal, 1) signal.Notify(ch, syscall.SIGTERM, syscall.SIGINT, syscall.SIGQUIT, syscall.SIGSEGV) \u003c-ch s.Close() } 在 service 的 Serve 方法启动前，我们先进行插件的初始化，也就是 InitPlugins 这个方法。这个方法里面会去遍历所有的插件，然后进行插件初始化。\nfunc (s *Server) InitPlugins() error { // init plugins for _, p := range s.plugins { switch val := p.(type) { case plugin.ResolverPlugin : var services []string for serviceName, _ := range s.services { services = append(services, serviceName) } pluginOpts := []plugin.Option { plugin.WithSelectorSvrAddr(s.opts.selectorSvrAddr), plugin.WithSvrAddr(s.opts.address), plugin.WithServices(services), } if err := val.Init(pluginOpts ...); err != nil { log.Errorf(\"resolver init error, %v\", err) return err } .... } } return nil } 如上，当发现是服务发现类插件 ResolverPlugin，就调用 Init 方法进行初始化，所以 consul 的初始化动作就是在这一步进行。\n5、客户端初始化 我们知道，服务端 server 需要和 consul 通信来进行服务注册。那么客户端 client 也要和 consul 通信来进行服务发现，那么 client 如何知道 consul 地址呢？这里也需要在 client 进行一步 consul 初始化动作。如下：\nfunc main() { opts := []client.Option { client.WithTarget(\"127.0.0.1:8000\"), client.WithNetwork(\"tcp\"), client.WithTimeout(2000 * time.Millisecond), client.WithSelectorName(consul.Name), } c := client.DefaultClient req := \u0026helloworld.HelloRequest{ Msg: \"hello\", } rsp := \u0026helloworld.HelloReply{} consul.Init(\"localhost:8500\") err := c.Call(context.Background(), \"/helloworld.Greeter/SayHello\", req, rsp, opts ...) fmt.Println(rsp.Msg, err) } 客户端进行 Call 调用下游之前，需要调用 consul.Init 方法设置 consul server 的监听地址，如下：\n// Init implements the initialization of the consul configuration when the framework is loaded func Init(consulSvrAddr string, opts ... plugin.Option) error { for _, o := range opts { o(ConsulSvr.opts) } ConsulSvr.opts.SelectorSvrAddr = consulSvrAddr err := ConsulSvr.InitConfig() return err } 这里的 Init 与 server 端调用 consul Init 一样，底层都是调用了 InitConfig 方法进行配置初始化。到这里，整个链路算是完整的串联起来。\n小结 本章先对 consul 做了一个快速介绍，然后介绍了框架服务发现实现的思路和具体代码实现。代码 demo 可以参考：consul\n","wordCount":"3294","inLanguage":"zh","datePublished":"2020-02-16T00:00:00+08:00","dateModified":"2020-02-16T00:00:00+08:00","author":{"@type":"Person","name":"丢哥"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://diu.life/lessons/go-rpc/service-discovery-implementation/"},"publisher":{"@type":"Organization","name":"丢哥","logo":{"@type":"ImageObject","url":"https://diu.life/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diu.life/ accesskey=h title="丢哥 (Alt + H)">丢哥</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://diu.life/ title=首页><span>首页</span></a></li><li><a href=https://diu.life/posts/ title=文章><span>文章</span></a></li><li><a href=https://diu.life/projects/ title=独立开发><span>独立开发</span></a></li><li><a href=https://diu.life/lessons/ title=教程><span>教程</span></a></li><li><a href=https://diu.life/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><div class=lesson-container><div class=lesson-sidebar><div class=lesson-nav><h3>Go-Rpc 教程</h3><ul class=chapter-list><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/what-is-rpc/ class=chapter-link><span class=chapter-title>第一章：RPC 原理</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/rpc-framework-overview/ class=chapter-link><span class=chapter-title>第二章：RPC 框架概览</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/build-server/ class=chapter-link><span class=chapter-title>第三章：框架搭建 —— server</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/build-client/ class=chapter-link><span class=chapter-title>第四章：框架搭建 —— client</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/build-transport/ class=chapter-link><span class=chapter-title>第五章：框架搭建 —— transport</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/context-timeout/ class=chapter-link><span class=chapter-title>第六章：超时机制</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/custom-protocol/ class=chapter-link><span class=chapter-title>第七章：自定义协议实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/codec/ class=chapter-link><span class=chapter-title>第八章：协议编解码实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/marshal-and-unmarshal/ class=chapter-link><span class=chapter-title>第九章：序列化实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/log-component/ class=chapter-link><span class=chapter-title>第十章：日志模块实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/connection-pool/ class=chapter-link><span class=chapter-title>第十一章：连接池实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/interceptor/ class=chapter-link><span class=chapter-title>第十二章：拦截器实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/component-interface/ class=chapter-link><span class=chapter-title>第十三章：组件可插拔实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/plugin/ class=chapter-link><span class=chapter-title>第十四章：插件体系实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/service-discovery-selection/ class=chapter-link><span class=chapter-title>第十五章：服务发现原理及选型</span></a></li><li class="chapter-item active"><a href=https://diu.life/lessons/go-rpc/service-discovery-implementation/ class=chapter-link><span class=chapter-title>第十六章：服务发现实现 —— consul</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/load-balance-implementation/ class=chapter-link><span class=chapter-title>第十七章：负载均衡实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/tracing-selection/ class=chapter-link><span class=chapter-title>第十八章：分布式链路追踪原理及选型</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/tracing-implementation/ class=chapter-link><span class=chapter-title>第十九章：分布式链路追踪实现 —— jaeger</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/auth/ class=chapter-link><span class=chapter-title>第二十章：认证鉴权实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/code-generation/ class=chapter-link><span class=chapter-title>第二十一章：代码生成工具实现</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/performance-test/ class=chapter-link><span class=chapter-title>第二十二章：框架性能测试</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/performance-optimization/ class=chapter-link><span class=chapter-title>第二十三章：框架性能优化</span></a></li><li class=chapter-item><a href=https://diu.life/lessons/go-rpc/summary/ class=chapter-link><span class=chapter-title>第二十四章：总结与展望</span></a></li></ul></div></div><div class=lesson-content><article class=post-single><header class=post-header><h1 class=post-title>第十六章：服务发现实现 —— consul</h1><div class=post-meta><time datetime=2020-02-16T00:00:00+08:00>2020-02-16</time></div></header><div class=post-content><p>上一章我们介绍了服务发现的具体原理以及技术选型，本章我们将从代码实现的角度来介绍下如何使用 consul 来进行框架服务发现支持。</p><h3 id=一consul-介绍>一、consul 介绍</h3><p>关于 consul 的介绍，最直接的可以参考官方 github 仓库 <a href=https://github.com/hashicorp/consul>consul</a>，或者直接参考 consul 官网 <a href=https://www.consul.io/>www.consul.io</a> 。这里我们只介绍最基础的环境安装和 quick start</p><h4 id=1consul-安装>1、consul 安装</h4><p>进入官网 <a href=https://www.consul.io/downloads.html>www.consul.io/downloads.h…</a> 下载 consul，假如是 mac 系统也可以使用 brew 安装。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>brew install consul
</span></span></code></pre></div><p>验证是否安装成功，打开一个命令行工具，输入 consul 命令，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>DEVLINTANG</span><span class=o>-</span><span class=nx>MB0</span><span class=p>:</span><span class=nx>Documents</span> <span class=nx>delvin</span><span class=err>$</span> <span class=nx>consul</span>
</span></span><span class=line><span class=cl><span class=nx>Usage</span><span class=p>:</span> <span class=nx>consul</span> <span class=p>[</span><span class=o>--</span><span class=nx>version</span><span class=p>]</span> <span class=p>[</span><span class=o>--</span><span class=nx>help</span><span class=p>]</span> <span class=p>&lt;</span><span class=nx>command</span><span class=p>&gt;</span> <span class=p>[&lt;</span><span class=nx>args</span><span class=p>&gt;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>Available</span> <span class=nx>commands</span> <span class=nx>are</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nx>acl</span>            <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>Consul</span><span class=err>&#39;</span><span class=nx>s</span> <span class=nx>ACLs</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>          <span class=nx>Runs</span> <span class=nx>a</span> <span class=nx>Consul</span> <span class=nx>agent</span>
</span></span><span class=line><span class=cl>    <span class=nx>catalog</span>        <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>the</span> <span class=nx>catalog</span>
</span></span><span class=line><span class=cl>    <span class=nx>config</span>         <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>Consul</span><span class=err>&#39;</span><span class=nx>s</span> <span class=nx>Centralized</span> <span class=nx>Configurations</span>
</span></span><span class=line><span class=cl>    <span class=nx>connect</span>        <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>Consul</span> <span class=nx>Connect</span>
</span></span><span class=line><span class=cl>    <span class=nx>debug</span>          <span class=nx>Records</span> <span class=nx>a</span> <span class=nx>debugging</span> <span class=nx>archive</span> <span class=k>for</span> <span class=nx>operators</span>
</span></span><span class=line><span class=cl>    <span class=nx>event</span>          <span class=nx>Fire</span> <span class=nx>a</span> <span class=nx>new</span> <span class=nx>event</span>
</span></span><span class=line><span class=cl>    <span class=nx>exec</span>           <span class=nx>Executes</span> <span class=nx>a</span> <span class=nx>command</span> <span class=nx>on</span> <span class=nx>Consul</span> <span class=nx>nodes</span>
</span></span><span class=line><span class=cl>    <span class=nx>force</span><span class=o>-</span><span class=nx>leave</span>    <span class=nx>Forces</span> <span class=nx>a</span> <span class=nx>member</span> <span class=nx>of</span> <span class=nx>the</span> <span class=nx>cluster</span> <span class=nx>to</span> <span class=nx>enter</span> <span class=nx>the</span> <span class=s>&#34;left&#34;</span> <span class=nx>state</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span>           <span class=nx>Provides</span> <span class=nx>debugging</span> <span class=nx>information</span> <span class=k>for</span> <span class=nx>operators</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nx>intention</span>      <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>Connect</span> <span class=nx>service</span> <span class=nx>intentions</span>
</span></span><span class=line><span class=cl>    <span class=nx>join</span>           <span class=nx>Tell</span> <span class=nx>Consul</span> <span class=nx>agent</span> <span class=nx>to</span> <span class=nx>join</span> <span class=nx>cluster</span>
</span></span><span class=line><span class=cl>    <span class=nx>keygen</span>         <span class=nx>Generates</span> <span class=nx>a</span> <span class=nx>new</span> <span class=nx>encryption</span> <span class=nx>key</span>
</span></span><span class=line><span class=cl>    <span class=nx>keyring</span>        <span class=nx>Manages</span> <span class=nx>gossip</span> <span class=nx>layer</span> <span class=nx>encryption</span> <span class=nx>keys</span>
</span></span><span class=line><span class=cl>    <span class=nx>kv</span>             <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>the</span> <span class=nx>key</span><span class=o>-</span><span class=nx>value</span> <span class=nx>store</span>
</span></span><span class=line><span class=cl>    <span class=nx>leave</span>          <span class=nx>Gracefully</span> <span class=nx>leaves</span> <span class=nx>the</span> <span class=nx>Consul</span> <span class=nx>cluster</span> <span class=nx>and</span> <span class=nx>shuts</span> <span class=nx>down</span>
</span></span><span class=line><span class=cl>    <span class=nx>lock</span>           <span class=nx>Execute</span> <span class=nx>a</span> <span class=nx>command</span> <span class=nx>holding</span> <span class=nx>a</span> <span class=nx>lock</span>
</span></span><span class=line><span class=cl>    <span class=nx>login</span>          <span class=nx>Login</span> <span class=nx>to</span> <span class=nx>Consul</span> <span class=nx>using</span> <span class=nx>an</span> <span class=nx>auth</span> <span class=nx>method</span>
</span></span><span class=line><span class=cl>    <span class=nx>logout</span>         <span class=nx>Destroy</span> <span class=nx>a</span> <span class=nx>Consul</span> <span class=nx>token</span> <span class=nx>created</span> <span class=nx>with</span> <span class=nx>login</span>
</span></span><span class=line><span class=cl>    <span class=nx>maint</span>          <span class=nx>Controls</span> <span class=nx>node</span> <span class=nx>or</span> <span class=nx>service</span> <span class=nx>maintenance</span> <span class=nx>mode</span>
</span></span><span class=line><span class=cl>    <span class=nx>members</span>        <span class=nx>Lists</span> <span class=nx>the</span> <span class=nx>members</span> <span class=nx>of</span> <span class=nx>a</span> <span class=nx>Consul</span> <span class=nx>cluster</span>
</span></span><span class=line><span class=cl>    <span class=nx>monitor</span>        <span class=nx>Stream</span> <span class=nx>logs</span> <span class=nx>from</span> <span class=nx>a</span> <span class=nx>Consul</span> <span class=nx>agent</span>
</span></span><span class=line><span class=cl>    <span class=nx>operator</span>       <span class=nx>Provides</span> <span class=nx>cluster</span><span class=o>-</span><span class=nx>level</span> <span class=nx>tools</span> <span class=k>for</span> <span class=nx>Consul</span> <span class=nx>operators</span>
</span></span><span class=line><span class=cl>    <span class=nx>reload</span>         <span class=nx>Triggers</span> <span class=nx>the</span> <span class=nx>agent</span> <span class=nx>to</span> <span class=nx>reload</span> <span class=nx>configuration</span> <span class=nx>files</span>
</span></span><span class=line><span class=cl>    <span class=nx>rtt</span>            <span class=nx>Estimates</span> <span class=nx>network</span> <span class=nx>round</span> <span class=nx>trip</span> <span class=nx>time</span> <span class=nx>between</span> <span class=nx>nodes</span>
</span></span><span class=line><span class=cl>    <span class=nx>services</span>       <span class=nx>Interact</span> <span class=nx>with</span> <span class=nx>services</span>
</span></span><span class=line><span class=cl>    <span class=nx>snapshot</span>       <span class=nx>Saves</span><span class=p>,</span> <span class=nx>restores</span> <span class=nx>and</span> <span class=nx>inspects</span> <span class=nx>snapshots</span> <span class=nx>of</span> <span class=nx>Consul</span> <span class=nx>server</span> <span class=nx>state</span>
</span></span><span class=line><span class=cl>    <span class=nx>tls</span>            <span class=nx>Builtin</span> <span class=nx>helpers</span> <span class=k>for</span> <span class=nx>creating</span> <span class=nx>CAs</span> <span class=nx>and</span> <span class=nx>certificates</span>
</span></span><span class=line><span class=cl>    <span class=nx>validate</span>       <span class=nx>Validate</span> <span class=nx>config</span> <span class=nx>files</span><span class=o>/</span><span class=nx>directories</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span>        <span class=nx>Prints</span> <span class=nx>the</span> <span class=nx>Consul</span> <span class=nx>version</span>
</span></span><span class=line><span class=cl>    <span class=nx>watch</span>          <span class=nx>Watch</span> <span class=k>for</span> <span class=nx>changes</span> <span class=nx>in</span> <span class=nx>Consul</span>
</span></span></code></pre></div><p>假如出现上面的指令列表，则说明 consul 安装成功。</p><h4 id=2consul-的运行>2、consul 的运行</h4><p>完成 consul 的安装后，就可以开始运行 agent，agent 可以运行为 server 或者 client 模式。每个数据中心必须至少拥有一个 server。一般建议在一个集群中部署 3~5 个 server，避免出现单点故障导致数据丢失。</p><p>假如 consul agent 的 client 模式，表现为一个非常轻量级的进程，用于注册服务、运行健康检查和转发对 server 的查询。</p><p>在 consul agent 的 client 模式下，所有注册到当前节点的服务会被转发到 server，本身是不持久化这些信息。在 consul agent 的 server 模式下，功能和 client 模式一样，唯一不同的是，它会把所有的信息持久化的本地，这样遇到故障，信息是可以被保留的。</p><p>快速启动一个单点的 consul，我们可以运行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>consul agent -dev
</span></span></code></pre></div><p>执行这个命令会输出一些日志，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>DEVLINTANG-MB0:Documents delvin$ consul agent -dev
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Starting Consul agent...
</span></span><span class=line><span class=cl>           Version: <span class=s1>&#39;v1.6.2&#39;</span>
</span></span><span class=line><span class=cl>           Node ID: <span class=s1>&#39;15993850-f9f0-1e07-08d0-7a27723c178b&#39;</span>
</span></span><span class=line><span class=cl>         Node name: <span class=s1>&#39;DEVLINTANG-MB0&#39;</span>
</span></span><span class=line><span class=cl>        Datacenter: <span class=s1>&#39;dc1&#39;</span> <span class=o>(</span>Segment: <span class=s1>&#39;&lt;all&gt;&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            Server: <span class=nb>true</span> <span class=o>(</span>Bootstrap: <span class=nb>false</span><span class=o>)</span>
</span></span><span class=line><span class=cl>       Client Addr: <span class=o>[</span>127.0.0.1<span class=o>]</span> <span class=o>(</span>HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600<span class=o>)</span>
</span></span><span class=line><span class=cl>      Cluster Addr: 127.0.0.1 <span class=o>(</span>LAN: 8301, WAN: 8302<span class=o>)</span>
</span></span><span class=line><span class=cl>           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false, Auto-Encrypt-TLS: <span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Log data will now stream in as it occurs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>DEBUG<span class=o>]</span> agent: Using random ID <span class=s2>&#34;15993850-f9f0-1e07-08d0-7a27723c178b&#34;</span> as node ID
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>DEBUG<span class=o>]</span> tlsutil: Update with version <span class=m>1</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>DEBUG<span class=o>]</span> tlsutil: OutgoingRPCWrapper with version <span class=m>1</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span>  raft: Initial configuration <span class=o>(</span><span class=nv>index</span><span class=o>=</span>1<span class=o>)</span>: <span class=o>[{</span>Suffrage:Voter ID:15993850-f9f0-1e07-08d0-7a27723c178b Address:127.0.0.1:8300<span class=o>}]</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span>  raft: Node at 127.0.0.1:8300 <span class=o>[</span>Follower<span class=o>]</span> entering Follower state <span class=o>(</span>Leader: <span class=s2>&#34;&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> serf: EventMemberJoin: DEVLINTANG-MB0.dc1 127.0.0.1
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> serf: EventMemberJoin: DEVLINTANG-MB0 127.0.0.1
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> consul: Adding LAN server DEVLINTANG-MB0 <span class=o>(</span>Addr: tcp/127.0.0.1:8300<span class=o>)</span> <span class=o>(</span>DC: dc1<span class=o>)</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> consul: Handled member-join event <span class=k>for</span> server <span class=s2>&#34;DEVLINTANG-MB0.dc1&#34;</span> in area <span class=s2>&#34;wan&#34;</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started DNS server 127.0.0.1:8600 <span class=o>(</span>udp<span class=o>)</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started DNS server 127.0.0.1:8600 <span class=o>(</span>tcp<span class=o>)</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started HTTP server on 127.0.0.1:8500 <span class=o>(</span>tcp<span class=o>)</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started gRPC server on 127.0.0.1:8502 <span class=o>(</span>tcp<span class=o>)</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: started state <span class=nv>syncer</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Consul agent running!
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>WARN<span class=o>]</span>  raft: Heartbeat timeout from <span class=s2>&#34;&#34;</span> reached, starting election
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span>  raft: Node at 127.0.0.1:8300 <span class=o>[</span>Candidate<span class=o>]</span> entering Candidate state in term <span class=m>2</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>DEBUG<span class=o>]</span> raft: Votes needed: <span class=m>1</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>DEBUG<span class=o>]</span> raft: Vote granted from 15993850-f9f0-1e07-08d0-7a27723c178b in term 2. Tally: <span class=m>1</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span>  raft: Election won. Tally: <span class=m>1</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span>  raft: Node at 127.0.0.1:8300 <span class=o>[</span>Leader<span class=o>]</span> entering Leader state
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> consul: cluster leadership acquired
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> consul: New leader elected: DEVLINTANG-MB0
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> connect: initialized primary datacenter CA with provider <span class=s2>&#34;consul&#34;</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>DEBUG<span class=o>]</span> consul: Skipping self join check <span class=k>for</span> <span class=s2>&#34;DEVLINTANG-MB0&#34;</span> since the cluster is too small
</span></span><span class=line><span class=cl>    2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> consul: member <span class=s1>&#39;DEVLINTANG-MB0&#39;</span> joined, marking health alive
</span></span><span class=line><span class=cl>    2020/04/06 18:00:34 <span class=o>[</span>DEBUG<span class=o>]</span> agent: Skipping remote check <span class=s2>&#34;serfHealth&#34;</span> since it is managed automatically
</span></span><span class=line><span class=cl>    2020/04/06 18:00:34 <span class=o>[</span>INFO<span class=o>]</span> agent: Synced node info
</span></span><span class=line><span class=cl>    2020/04/06 18:00:35 <span class=o>[</span>DEBUG<span class=o>]</span> tlsutil: OutgoingRPCWrapper with version <span class=m>1</span>
</span></span><span class=line><span class=cl>    2020/04/06 18:00:36 <span class=o>[</span>DEBUG<span class=o>]</span> agent: Skipping remote check <span class=s2>&#34;serfHealth&#34;</span> since it is managed automatically
</span></span><span class=line><span class=cl>    2020/04/06 18:00:36 <span class=o>[</span>DEBUG<span class=o>]</span> agent: Node info in sync
</span></span><span class=line><span class=cl>    2020/04/06 18:00:36 <span class=o>[</span>DEBUG<span class=o>]</span> agent: Node info in sync
</span></span></code></pre></div><p>-dev 这个参数是创建一个开发环境的 server 节点。该参数配置下，不会有任何持久化操作，即不会有任何数据写入到磁盘，所以它不能用于生产环境。</p><p>仔细看下面这一段信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started DNS server 127.0.0.1:8600 <span class=o>(</span>udp<span class=o>)</span>
</span></span><span class=line><span class=cl>2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started DNS server 127.0.0.1:8600 <span class=o>(</span>tcp<span class=o>)</span>
</span></span><span class=line><span class=cl>2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started HTTP server on 127.0.0.1:8500 <span class=o>(</span>tcp<span class=o>)</span>
</span></span><span class=line><span class=cl>2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: Started gRPC server on 127.0.0.1:8502 <span class=o>(</span>tcp<span class=o>)</span>
</span></span><span class=line><span class=cl>2020/04/06 18:00:33 <span class=o>[</span>INFO<span class=o>]</span> agent: started state syncer
</span></span></code></pre></div><p>可以看到 consul 启动了 DNS 、HTTP、gRPC 三个 server 来分别监听不同协议的请求。由于我们的实现是会采用 HTTP 协议通信，所以将会去请求 127.0.0.1:8500 这个地址。</p><p>我们可以执行下面命令来查看这个节点的信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>consul members
</span></span></code></pre></div><p>显示的信息如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Node            Address         Status  Type    Build  Protocol  DC   Segment
</span></span><span class=line><span class=cl>DEVLINTANG-MB0  127.0.0.1:8301  alive   server  1.6.2  <span class=m>2</span>         dc1  &lt;all&gt;
</span></span></code></pre></div><p>可以看到，consul agent -dev 这条命令创建了一个 server 类型的节点。</p><h3 id=三实现思路>三、实现思路</h3><p>上面对 consul 做了简单的介绍。要基于 consul 实现服务发现，我们首先需要明确实现思路。</p><h4 id=1服务什么时候注册>1、服务什么时候注册？</h4><p>服务注册，框架在 Server 中提供了注册 Service 的 Register 方法。Register 中会将一个或多个 Service 添加到一个 Server 中。此时，这个 Service 应该去向 consul server 发起注册，consul 会将 Service 的服务名和服务地址保存在一个 k-v 存储中。与 consul 的通信有 DNS、HTTP、gRPC 三种协议，我们采取通用的 HTTP 协议实现。</p><h4 id=2服务发现怎么实现>2、服务发现怎么实现？</h4><p>因为我们采用的是客户端服务发现的模式，所以由 client 去请求 consul server，根据某个 Service 的服务名，去 consul 的 k-v 存储中获取到服务的地址。通信的方式也是 HTTP 协议。</p><h4 id=3consul-如何初始化>3、consul 如何初始化？</h4><p>这里由于引入了 consul，要想使用 consul 提供的服务发现能力，我们在启动 Server 之前，要先进行 consul 的初始化，启动 consul 服务，这样才能保证 consul 能够接收我们的服务注册、服务发现的请求。</p><p>关于 consul 的初始化过程，我们将其统一放在插件初始化过程中去实现。这符合框架的插件化、可插拔的思想。</p><h3 id=四具体实现>四、具体实现</h3><p>明确了实现思路，接下来我们就开始代码实现。</p><p>首先，上面说到了，consul 是以插件的形式去实现，也就是在 plugin 目录下。</p><h4 id=1定义-consul>1、定义 consul</h4><p>consul 定义如下，由于 consul 是一个独立的服务，所以它有自己的一套配置，我们在 Consul 的定义里面加上了一些 consul 配置的属性。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Consul implements the server discovery specification</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Consul</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>opts</span> <span class=o>*</span><span class=nx>plugin</span><span class=p>.</span><span class=nx>Options</span>
</span></span><span class=line><span class=cl>   <span class=nx>client</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>   <span class=nx>config</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>Config</span>
</span></span><span class=line><span class=cl>   <span class=nx>balancerName</span> <span class=kt>string</span>  <span class=c1>// load balancing mode, including random, polling, weighted polling, consistent hash, etc</span>
</span></span><span class=line><span class=cl>   <span class=nx>writeOptions</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>WriteOptions</span>
</span></span><span class=line><span class=cl>   <span class=nx>queryOptions</span> <span class=o>*</span><span class=nx>api</span><span class=p>.</span><span class=nx>QueryOptions</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=2实现-selector>2、实现 Selector</h4><p>由于 consul 是服务发现组件，所以它需要实现服务发现的统一接口 Selector，也就是 Select 函数，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// implements selector Select method</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Consul</span><span class=p>)</span> <span class=nf>Select</span><span class=p>(</span><span class=nx>serviceName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>nodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Resolve</span><span class=p>(</span><span class=nx>serviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>nodes</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>balancer</span> <span class=o>:=</span> <span class=nx>selector</span><span class=p>.</span><span class=nf>GetBalancer</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>balancerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>node</span> <span class=o>:=</span> <span class=nx>balancer</span><span class=p>.</span><span class=nf>Balance</span><span class=p>(</span><span class=nx>serviceName</span><span class=p>,</span><span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>node</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;no services find in %s&#34;</span><span class=p>,</span> <span class=nx>serviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nf>parseAddrFromNode</span><span class=p>(</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Select 就分为两步了，第一步 Resolve 方法其实就是服务发现的过程，Balance 是负载均衡实现。这里后续会介绍，这里我们聚焦于服务发现，也就是 Resolve 这个方法，看看它是怎么去实现服务发现的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Consul</span><span class=p>)</span> <span class=nf>Resolve</span><span class=p>(</span><span class=nx>serviceName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>selector</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>pairs</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>KV</span><span class=p>().</span><span class=nf>List</span><span class=p>(</span><span class=nx>serviceName</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pairs</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;no services find in path : %s&#34;</span><span class=p>,</span> <span class=nx>serviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>nodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>selector</span><span class=p>.</span><span class=nx>Node</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pair</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pairs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>nodes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nodes</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>selector</span><span class=p>.</span><span class=nx>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>Key</span> <span class=p>:</span> <span class=nx>pair</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>Value</span> <span class=p>:</span> <span class=nx>pair</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>nodes</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到，Resolve 这个方法是通过一个服务名去获取服务列表。它的核心是调用了 c.client.KV().List(serviceName, nil) 这个方法，这里 c 是 Consul 对象，client 是 *api.Client，其实这里我们是通过 consul 的 api 去与 consul 进行通信，具体 api 是通过引用 github.com/hashicorp/consul/api 这个包进行实现，具体可以参考：<a href=https://github.com/hashicorp/consul/tree/master/api>consul api</a> 。通过 api KV 的 List 方法，从 consul k-v 存储中获取服务列表。</p><h4 id=3实现-plugin>3、实现 Plugin</h4><p>由于 consul 是以插件化的形式实现的，所以我们同样也需要实现插件的通用接口 Plugin。这里由于服务发现插件和 tracing 的插件都有其个性化配置，导致其初始化方法的结构不一样，所以细化了一下 Plugin 接口，分为 ResolverPlugin 和 TracingPlugin 两类，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ResolverPlugin defines the standard for all server discovery plug-ins</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ResolverPlugin</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>Init</span><span class=p>(</span><span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// TracingPlugin defines the standard for all tracing plug-ins</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TracingPlugin</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>Init</span><span class=p>(</span><span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=nx>opentracing</span><span class=p>.</span><span class=nx>Tracer</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里我们需要去实现 ResolverPlugin 这个接口，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Consul</span><span class=p>)</span> <span class=nf>Init</span><span class=p>(</span><span class=nx>opts</span> <span class=o>...</span><span class=nx>plugin</span><span class=p>.</span><span class=nx>Option</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>o</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>o</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Services</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SvrAddr</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SelectorSvrAddr</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;consul init error, len(services) : %d, svrAddr : %s, selectorSvrAddr : %s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nb>len</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Services</span><span class=p>),</span> <span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SvrAddr</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SelectorSvrAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>InitConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>serviceName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Services</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>nodeName</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/%s&#34;</span><span class=p>,</span> <span class=nx>serviceName</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SvrAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>kvPair</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>api</span><span class=p>.</span><span class=nx>KVPair</span><span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>Key</span> <span class=p>:</span> <span class=nx>nodeName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nx>Value</span> <span class=p>:</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SvrAddr</span><span class=p>),</span>
</span></span><span class=line><span class=cl>         <span class=nx>Flags</span><span class=p>:</span> <span class=nx>api</span><span class=p>.</span><span class=nx>LockFlagValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>KV</span><span class=p>().</span><span class=nf>Put</span><span class=p>(</span><span class=nx>kvPair</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>writeOptions</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>前面我们说到了，Server 启动的时候需要将 Service 去 consul 上进行注册，这个方法实现了服务注册的过程。想将服务名和服务地址包装秤 KVPair 的形式，然后通过调用 consul api 的 Put 方法进行的将 KVPair 同步到 consul 的 k-v 存储。</p><h4 id=4服务初始化过程>4、服务初始化过程</h4><p>上面说到了 Init(opts &mldr;plugin.Option) 这个方法实现了服务初始化。那么它什么时候被调用呢？</p><p>其实就是在服务启动之前，其实就是在 Serve() 这个方法里面，我们来看：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>Serve</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>InitPlugins</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>service</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>services</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>go</span> <span class=nx>service</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>ch</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>ch</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGQUIT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGSEGV</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=o>&lt;-</span><span class=nx>ch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>s</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 service 的 Serve 方法启动前，我们先进行插件的初始化，也就是 InitPlugins 这个方法。这个方法里面会去遍历所有的插件，然后进行插件初始化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>InitPlugins</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// init plugins</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>plugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>switch</span> <span class=nx>val</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>ResolverPlugin</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>         <span class=kd>var</span> <span class=nx>services</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=nx>serviceName</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>services</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>services</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>services</span><span class=p>,</span> <span class=nx>serviceName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=nx>pluginOpts</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>plugin</span><span class=p>.</span><span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>plugin</span><span class=p>.</span><span class=nf>WithSelectorSvrAddr</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>selectorSvrAddr</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>plugin</span><span class=p>.</span><span class=nf>WithSvrAddr</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>address</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=nx>plugin</span><span class=p>.</span><span class=nf>WithServices</span><span class=p>(</span><span class=nx>services</span><span class=p>),</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>val</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=nx>pluginOpts</span> <span class=o>...</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;resolver init error, %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    	<span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如上，当发现是服务发现类插件 ResolverPlugin，就调用 Init 方法进行初始化，所以 consul 的初始化动作就是在这一步进行。</p><h4 id=5客户端初始化>5、客户端初始化</h4><p>我们知道，服务端 server 需要和 consul 通信来进行服务注册。那么客户端 client 也要和 consul 通信来进行服务发现，那么 client 如何知道 consul 地址呢？这里也需要在 client 进行一步 consul 初始化动作。如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>opts</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>client</span><span class=p>.</span><span class=nx>Option</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>.</span><span class=nf>WithTarget</span><span class=p>(</span><span class=s>&#34;127.0.0.1:8000&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>.</span><span class=nf>WithNetwork</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=mi>2000</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>),</span>
</span></span><span class=line><span class=cl>      <span class=nx>client</span><span class=p>.</span><span class=nf>WithSelectorName</span><span class=p>(</span><span class=nx>consul</span><span class=p>.</span><span class=nx>Name</span><span class=p>),</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>c</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>DefaultClient</span>
</span></span><span class=line><span class=cl>   <span class=nx>req</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>helloworld</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Msg</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>rsp</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>helloworld</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>consul</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=s>&#34;localhost:8500&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Call</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=s>&#34;/helloworld.Greeter/SayHello&#34;</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>rsp</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>rsp</span><span class=p>.</span><span class=nx>Msg</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>客户端进行 Call 调用下游之前，需要调用 consul.Init 方法设置 consul server 的监听地址，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Init implements the initialization of the consul configuration when the framework is loaded</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Init</span><span class=p>(</span><span class=nx>consulSvrAddr</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>Option</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>o</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>o</span><span class=p>(</span><span class=nx>ConsulSvr</span><span class=p>.</span><span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>ConsulSvr</span><span class=p>.</span><span class=nx>opts</span><span class=p>.</span><span class=nx>SelectorSvrAddr</span> <span class=p>=</span> <span class=nx>consulSvrAddr</span>
</span></span><span class=line><span class=cl>   <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ConsulSvr</span><span class=p>.</span><span class=nf>InitConfig</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里的 Init 与 server 端调用 consul Init 一样，底层都是调用了 InitConfig 方法进行配置初始化。到这里，整个链路算是完整的串联起来。</p><h3 id=小结>小结</h3><p>本章先对 consul 做了一个快速介绍，然后介绍了框架服务发现实现的思路和具体代码实现。代码 demo 可以参考：<a href=https://github.com/lubanproj/gorpc/tree/master/plugin/consul>consul</a></p></div><div class=lesson-navigation><div class=nav-buttons><a href=https://diu.life/lessons/go-rpc/service-discovery-selection/ class="nav-btn prev-btn"><span>← 上一章</span>
<span class=nav-title>第十五章：服务发现原理及选型</span>
</a><a href=https://diu.life/lessons/go-rpc/load-balance-implementation/ class="nav-btn next-btn"><span>下一章 →</span>
<span class=nav-title>第十七章：负载均衡实现</span></a></div></div></article></div></div><style>.main{max-width:100% !important;padding:0 !important}.lesson-container{display:flex;min-height:calc(100vh - 60px);gap:0;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%)}.lesson-sidebar{width:320px;background:linear-gradient(180deg,#ffffff 0%,#f8f9fa 100%);border-right:none;box-shadow:2px 0 20px rgba(0,0,0,8%);position:sticky;top:60px;height:calc(100vh - 60px);overflow-y:auto;padding:30px 25px;z-index:10}.lesson-nav h3{margin:0 0 30px;color:#2c3e50;font-size:1.4em;font-weight:700;text-align:center;padding-bottom:15px;border-bottom:2px solid #e3f2fd;position:relative}.lesson-nav h3::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:60px;height:2px;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%)}.chapter-list{list-style:none;padding:0;margin:0}.chapter-item{margin-bottom:12px}.chapter-link{display:block;padding:16px 20px;color:#5a6c7d;text-decoration:none;border-radius:12px;transition:all .3s cubic-bezier(.4,0,.2,1);border:1px solid transparent;background:rgba(255,255,255,.7);backdrop-filter:blur(10px);position:relative;overflow:hidden}.chapter-link::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);transition:left .5s}.chapter-link:hover{background:rgba(255,255,255,.9);color:#2c3e50;transform:translateX(8px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.chapter-link:hover::before{left:100%}.chapter-item.active .chapter-link{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;font-weight:600;box-shadow:0 10px 30px rgba(102,126,234,.3);transform:translateX(8px)}.chapter-item.active .chapter-link::before{display:none}.chapter-title{font-size:.95em;line-height:1.5;font-weight:500}.lesson-content{flex:1;padding:40px 50px;width:100%;overflow-x:auto;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);margin:20px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.1);position:relative}.lesson-content::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);border-radius:20px 20px 0 0}.post-single{max-width:100%;margin:0}.post-header{margin-bottom:40px;padding-bottom:20px;border-bottom:1px solid #e8ecef}.post-title{font-size:2.2em;font-weight:800;margin:0 0 15px;color:#2c3e50;line-height:1.3;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.post-meta{color:#7f8c8d;font-size:.95em;font-weight:500}.post-content{line-height:1.8;color:#34495e;font-size:1.05em}.post-content h2{margin-top:50px;margin-bottom:25px;font-size:1.6em;font-weight:700;color:#2c3e50;position:relative;padding-left:20px}.post-content h2::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:60%;background:linear-gradient(180deg,#667eea 0%,#764ba2 100%);border-radius:2px}.post-content h3{margin-top:35px;margin-bottom:20px;font-size:1.4em;font-weight:600;color:#2c3e50}.post-content p{margin-bottom:20px;text-align:justify}.post-content ul,.post-content ol{margin-bottom:20px;padding-left:25px}.post-content li{margin-bottom:10px;line-height:1.7}.post-content code{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);padding:4px 8px;border-radius:6px;font-size:.9em;color:#e83e8c;font-weight:500;border:1px solid #dee2e6}.post-content pre{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);padding:25px;border-radius:12px;overflow-x:auto;margin:30px 0;box-shadow:0 10px 30px rgba(0,0,0,.1);border:1px solid #4a5568}.post-content pre code{background:0 0;padding:0;border-radius:0;color:#a0aec0;border:none}.lesson-navigation{margin-top:60px;padding-top:40px;border-top:2px solid #e8ecef;position:relative}.lesson-navigation::before{content:'';position:absolute;top:-2px;left:50%;transform:translateX(-50%);width:100px;height:2px;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%)}.nav-buttons{display:flex;justify-content:space-between;gap:25px}.nav-btn{display:flex;flex-direction:column;padding:20px 25px;background:linear-gradient(135deg,#ffffff 0%,#f8f9fa 100%);border:2px solid #e9ecef;border-radius:15px;text-decoration:none;color:#2c3e50;transition:all .3s cubic-bezier(.4,0,.2,1);flex:1;max-width:320px;position:relative;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,8%)}.nav-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(102,126,234,.1),transparent);transition:left .6s}.nav-btn:hover{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-color:#667eea;color:#fff;transform:translateY(-3px);box-shadow:0 15px 40px rgba(102,126,234,.3)}.nav-btn:hover::before{left:100%}.nav-btn span:first-child{font-size:.95em;color:#7f8c8d;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}.nav-btn:hover span:first-child{color:rgba(255,255,255,.9)}.nav-title{font-weight:600;line-height:1.4;font-size:1.05em}.next-btn{text-align:right}@media(max-width:768px){.lesson-container{flex-direction:column;background:linear-gradient(180deg,#f5f7fa 0%,#c3cfe2 100%)}.lesson-sidebar{width:100%;height:auto;position:static;border-right:none;border-bottom:2px solid #e8ecef;box-shadow:0 2px 15px rgba(0,0,0,.1);padding:25px 20px;margin:0;border-radius:0}.lesson-content{max-width:100%;padding:30px 20px;margin:15px;border-radius:15px}.post-title{font-size:1.8em}.post-content{font-size:1em}.nav-buttons{flex-direction:column;gap:15px}.nav-btn{max-width:100%}.next-btn{text-align:left}.chapter-link:hover,.chapter-item.active .chapter-link{transform:none}}</style></main><footer class=footer><span>&copy; 2021 丢哥 all rights reserved.</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>