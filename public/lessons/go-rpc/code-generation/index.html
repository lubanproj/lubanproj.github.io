<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>第二十一章：代码生成工具实现 | 丢哥</title>
<meta name="keywords" content="">
<meta name="description" content="前面我们说到了 gorpc 调用有反射和代码生成两种调用方式。前面的介绍一直都以反射的调用方式来进行介绍。下面我们先来介绍一下代码生成方式的调用全过程，接着介绍下代码生成工具的调研和具体实现。">
<meta name="author" content="丢哥">
<link rel="canonical" href="https://diu.life/lessons/go-rpc/code-generation/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.2211ca3164be7830024f6aad2b3a2e520843a64f8f048445c3401c1249aa051d.css" integrity="sha256-IhHKMWS&#43;eDACT2qtKzouUghDpk&#43;PBIRFw0AcEkmqBR0=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://diu.life/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://diu.life/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://diu.life/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://diu.life/apple-touch-icon.png">
<link rel="mask-icon" href="https://diu.life/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://diu.life/lessons/go-rpc/code-generation/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2499390968830075"
     crossorigin="anonymous"></script><style>
.footer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    text-align: center;
}

.footer-links {
    font-size: 0.9em;
    opacity: 0.8;
    white-space: nowrap;
}

.footer-links a {
    color: inherit;
    text-decoration: none;
    margin: 0 5px;
}

.footer-links a:hover {
    text-decoration: underline;
}

.footer-links a:first-child {
    margin-left: 0;
}

.footer-links a:last-child {
    margin-right: 0;
}

@media (max-width: 600px) {
    .footer-content {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .footer-copyright {
        text-align: center;
    }
}
</style><meta property="og:url" content="https://diu.life/lessons/go-rpc/code-generation/">
  <meta property="og:site_name" content="丢哥">
  <meta property="og:title" content="第二十一章：代码生成工具实现">
  <meta property="og:description" content="前面我们说到了 gorpc 调用有反射和代码生成两种调用方式。前面的介绍一直都以反射的调用方式来进行介绍。下面我们先来介绍一下代码生成方式的调用全过程，接着介绍下代码生成工具的调研和具体实现。">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="lessons">
    <meta property="article:published_time" content="2020-02-21T00:00:00+08:00">
    <meta property="article:modified_time" content="2020-02-21T00:00:00+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第二十一章：代码生成工具实现">
<meta name="twitter:description" content="前面我们说到了 gorpc 调用有反射和代码生成两种调用方式。前面的介绍一直都以反射的调用方式来进行介绍。下面我们先来介绍一下代码生成方式的调用全过程，接着介绍下代码生成工具的调研和具体实现。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "教程",
      "item": "https://diu.life/lessons/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "从 0 到 1 开发一款高性能 RPC 框架",
      "item": "https://diu.life/lessons/go-rpc/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "第二十一章：代码生成工具实现",
      "item": "https://diu.life/lessons/go-rpc/code-generation/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "第二十一章：代码生成工具实现",
  "name": "第二十一章：代码生成工具实现",
  "description": "前面我们说到了 gorpc 调用有反射和代码生成两种调用方式。前面的介绍一直都以反射的调用方式来进行介绍。下面我们先来介绍一下代码生成方式的调用全过程，接着介绍下代码生成工具的调研和具体实现。\n",
  "keywords": [
    
  ],
  "articleBody": "前面我们说到了 gorpc 调用有反射和代码生成两种调用方式。前面的介绍一直都以反射的调用方式来进行介绍。下面我们先来介绍一下代码生成方式的调用全过程，接着介绍下代码生成工具的调研和具体实现。\n一、以代码生成方式调用全过程。 定义一个服务，这里使用 proto 文件的形式进行定义 syntax = \"proto3\"; package helloworld; service Greeter { rpc SayHello (HelloRequest) returns (HelloReply) {} } message HelloRequest { string msg = 1; } message HelloReply { string msg = 1; } 安装 protoc-gen-gorpc 代码生成工具，在终端执行（前提是需要已经安装 protoc 工具，详情可参考protoc-gen-go 安装） go get -v github.com/lubanproj/protoc-gen-gorpc 执行 protoc --gorpc_out=plugin:. helloworld.proto 测试会生成 helloworld.pb.go 文件，这个文件里面包括 server 的描述文件和 client 的 stub 代码。\n二、代码生成的文件内容 代码生成的文件内容主要有两块：\n第一块主要是 server 服务信息，包括 GreeterService （服务的接口定义）、RegisterService（服务的注册函数）、 _Greeter_serviceDesc（服务名、方法名等描述信息） 、GreeterService_SayHello_Handler（方法的 Handler）等信息，如下：\n// This following code was generated by protoc-gen-gorpc, DO NOT EDIT!!! //================== server skeleton =================== type GreeterService interface { SayHello(ctx context.Context, req *HelloRequest) (*HelloReply, error) } var _Greeter_serviceDesc = \u0026gorpc.ServiceDesc{ ServiceName: \"helloworld.Greeter\", HandlerType: (*GreeterService)(nil), Methods: []*gorpc.MethodDesc{ { MethodName: \"SayHello\", Handler: GreeterService_SayHello_Handler, }, }, } func GreeterService_SayHello_Handler(ctx context.Context, svr interface{}, dec func(interface{}) error, ceps []interceptor.ServerInterceptor) (interface{}, error) { req := new(HelloRequest) if err := dec(req); err != nil { return nil, err } if len(ceps) == 0 { return svr.(GreeterService).SayHello(ctx, req) } handler := func(ctx context.Context, reqbody interface{}) (interface{}, error) { return svr.(GreeterService).SayHello(ctx, reqbody.(*HelloRequest)) } return interceptor.ServerIntercept(ctx, req, ceps, handler) } func RegisterService(s *gorpc.Server, svr interface{}) { s.Register(_Greeter_serviceDesc, svr) } 第二块主要包括 client 桩代码，主要生成了一个 proxy 代理 GreeterClientProxy ，以及代理的实现 GreeterClientProxyImpl，GreeterClientProxyImpl 实现了 GreeterClientProxy 接口定义的 SayHello 方法。\n//================== client stub=================== //GreeterClientProxy is a client proxy for service Greeter. type GreeterClientProxy interface { SayHello(ctx context.Context, req *HelloRequest, opts ...client.Option) (*HelloReply, error) } type GreeterClientProxyImpl struct { client client.Client opts []client.Option } func NewGreeterClientProxy(opts ...client.Option) GreeterClientProxy { return \u0026GreeterClientProxyImpl{client: client.DefaultClient, opts: opts} } // SayHello is server rpc method as defined func (c *GreeterClientProxyImpl) SayHello(ctx context.Context, req *HelloRequest, opts ...client.Option) (*HelloReply, error) { callopts := make([]client.Option, 0, len(c.opts)+len(opts)) callopts = append(callopts, c.opts...) callopts = append(callopts, opts...) rsp := \u0026HelloReply{} err := c.client.Invoke(ctx, req, rsp, \"/helloworld.Greeter/SayHello\", callopts...) if err != nil { return nil, err } return rsp, nil } 三、为什么需要代码生成？ 我们知道，server 收到 client 请求后，需要调用相应的 Handler 去处理，通过反射的方式去调用服务，Handler 里面的服务名、方法名等信息需要通过 reflect 包去动态获取，这个过程是有不小性能损耗的（下一章节会介绍）。假如不 care 这点性能损耗，又比较喜欢通过 go struct 的形式定义服务，当然可以采用这种方式。假如 care 性能损耗的话，就可以使用代码生成的方式，通过代码生成工具，将 proto 文件里面定义的 Service 生成相应的 server handler 和 client stub 代码。服务名、方法名、Handler 等信息提前静态生成好，就能避免反射带来的性能损耗。\n四、代码生成工具实现思路 要基于 protoc 实现代码生成工具，首先需要去了解 protoc 代码生成的原理，如下图（图片来源于网络）：\n从上图可以看到，protoc 代码生成主要分为五个步骤，我们只需要关注第三个步骤——插件的实现即可。\nprotoc 工具为了支持 go 语言的代码生成，提供了 protoc-gen-go 插件，在执行 protoc 命令时加上 –go_out 这个选项，protoc 就会默认去找 protoc-gen-go 这个插件，既然是关注插件的实现，那么我们有两种方式可以做到：\n1、模仿 grpc 的方式 由于 grpc 和 protobuf 都是 google 的项目，google 默认在 protoc-gen-go 这个项目下有一个 grpc 目录去负责 grpc 的代码生成，参考：protoc-gen-go\n使用 protoc 生成 grpc 的调用代码命令如下：\nprotoc --go_out=plugins=grpc:. --go_opt=paths=source_relative helloworld/helloworld.proto 可以看到 protoc 也是使用 –go_out=plugins=grpc 这个参数选项，传入 plugins 这个参数，当发现 plugins 这个参数时，protoc 会去找实现了 Plugin 接口的插件， protoc-gen-go 项目的 grpc 包刚好实现了 Plugin 插件，所以就会执行 grpc.go 中的代码，生成 grpc 的调用代码 grpc.go\n假如需要模仿 grpc，那么我们需要下载 protoc-gen-go 的包，然后建立一个与 grpc 同目录的包 gorpc，实现 Plugin 插件，代码生成时采用 protoc –go_out=plugins=gorpc:. 这种方式。\n2、制作 protoc-gen-gorpc 插件 第二种方式是使用 protoc –gorpc_out=:. 这个命令，这个命令会去你的系统 Path 路径去寻找 protoc-gen-gorpc 的 bin 文件去执行代码生成，相比于第一种方式而言，这种方式更加灵活。\n考虑到灵活性，我们选择第二种方式进行代码生成。\n五、代码生成工具实现细节 1、main 函数的编写 main 函数的编写主要是实现了上图的第三个步骤，从 os.Stdin 中读取二进制数据，然后反序列化成 CodeGeneratorRequest 对象，然后解析 CodeGeneratorRequest ，根据需求构造 CodeGeneratorResponse 对象，将 CodeGeneratorResponse 对象序列化成二进制数据，通过 os.Stout 返回给 protoc 插件。这里的代码目前所有社区的 protoc 插件都可以通用，直接 copy 即可：main.go\n2、实现 Plugin 上面说到了，要根据 protoc 制作一个代码生成插件，需要实现 Plugin 接口，我们先来看看 Plugin 接口如下：\n// A Plugin provides functionality to add to the output during Go code generation, // such as to produce RPC stubs. type Plugin interface { // Name identifies the plugin. Name() string // Init is called once after data structures are built but before // code generation begins. Init(g *Generator) // Generate produces the code generated by the plugin for this file, // except for the imports, by calling the generator's methods P, In, and Out. Generate(file *FileDescriptor) // GenerateImports produces the import declarations for this file. // It is called after Generate. GenerateImports(file *FileDescriptor) } 我们主要是实现 Generate 方法即可，在 main.go 的 g.GenerateAllFiles() ——\u003e g.generate(file) ——\u003e g.runPlugins(file) 里面会去执行所有实现了 Plugin 接口插件的代码，主要是调用 Generate() 方法，如下：\n// Run all the plugins associated with the file. func (g *Generator) runPlugins(file *FileDescriptor) { gorpclog.Debugf(\"plugins : %v\", plugins) gorpclog.Debugf(\"len(plugins) : %d\", len(plugins)) for _, p := range plugins { p.Generate(file) } } 3、实现 Generate gorpc 的 Generate 方法主要是生成 import 和针对每个 proto 文件定义的 Service，去生成具体 Service 代码\n// Generate generates code for the services in the given file. func (p *gorpc) Generate(file *generator.FileDescriptor) { if len(file.FileDescriptorProto.Service) == 0 { return } _ = p.gen.AddImport(gorpcServerPkgPath) _ = p.gen.AddImport(gorpcClientPkgPath) _ = p.gen.AddImport(gorpcInterceptorPkgPath) _ = p.gen.AddImport(\"context\") // generate all services for i, service := range file.FileDescriptorProto.Service { p.generateService(file, service, i) } } 4、实现 generateService 下面这段代码实现了 gorpc 的所有需要的 server 代码 和 client stub 代码的生成，它的核心原理主要是调用 p.P 去生成静态代码，通过 generator.FileDescriptor 、pb.ServiceDescriptorProto 这两个对象，获得 proto 文件定义的服务信息，然后生成相应的静态代码，这里就不过多赘述，读者直接读源码即可。\n// generateService generates all the code for the named service func (p *gorpc) generateService(file *generator.FileDescriptor, service *pb.ServiceDescriptorProto, index int) { originServiceName := service.GetName() serviceName := upperFirstLatter(originServiceName) p.P(\"// This following code was generated by protoc-gen-gorpc, DO NOT EDIT!!!\") p.P() p.P(\"//================== server skeleton ===================\") p.P(fmt.Sprintf(`type %sService interface { `, serviceName)) for _, method := range service.Method { p.generateServerInterfaceCode(method) } p.P(\"}\") p.generateServiceDesc(service, file.GetPackage()) for _, method := range service.Method { p.generateServerCode(service, method, file.GetPackage()) } p.generateRegisterCode(service) p.P(\"//================== client stub===================\") p.P(fmt.Sprintf(`//%sClientProxy is a client proxy for service %s. type %sClientProxy interface { `, serviceName, serviceName, serviceName)) for _, method := range service.Method { p.generateClientInterfaceCode(method) } p.P(\"}\") p.P(fmt.Sprintf(` type %sClientProxyImpl struct { client client.Client opts []client.Option } `, serviceName)) p.P(fmt.Sprintf(` func New%sClientProxy(opts ...client.Option) %sClientProxy { return \u0026%sClientProxyImpl{client: client.DefaultClient, opts: opts} } `, serviceName, serviceName, serviceName)) for _, method := range service.Method { p.generateClientCode(service, method, file.GetPackage()) } } 六、小结 本章节主要介绍了 gorpc 代码生成工具的原理和实现，源码详见：protoc-gen-gorpc\n",
  "wordCount" : "2259",
  "inLanguage": "zh",
  "datePublished": "2020-02-21T00:00:00+08:00",
  "dateModified": "2020-02-21T00:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "丢哥"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://diu.life/lessons/go-rpc/code-generation/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "丢哥",
    "logo": {
      "@type": "ImageObject",
      "url": "https://diu.life/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://diu.life/" accesskey="h" title="丢哥 (Alt + H)">丢哥</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://diu.life/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://diu.life/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://diu.life/projects/" title="独立开发">
                    <span>独立开发</span>
                </a>
            </li>
            <li>
                <a href="https://diu.life/lessons/" title="教程">
                    <span>教程</span>
                </a>
            </li>
            <li>
                <a href="https://diu.life/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">
<div class="lesson-container">
  
  <div class="lesson-sidebar">
    <div class="lesson-nav">
      <h3>Go-Rpc 教程</h3>
      <ul class="chapter-list">
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/what-is-rpc/" class="chapter-link">
            <span class="chapter-title">第一章：RPC 原理</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/rpc-framework-overview/" class="chapter-link">
            <span class="chapter-title">第二章：RPC 框架概览</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/build-server/" class="chapter-link">
            <span class="chapter-title">第三章：框架搭建 —— server</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/build-client/" class="chapter-link">
            <span class="chapter-title">第四章：框架搭建 —— client</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/build-transport/" class="chapter-link">
            <span class="chapter-title">第五章：框架搭建 —— transport</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/context-timeout/" class="chapter-link">
            <span class="chapter-title">第六章：超时机制</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/custom-protocol/" class="chapter-link">
            <span class="chapter-title">第七章：自定义协议实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/codec/" class="chapter-link">
            <span class="chapter-title">第八章：协议编解码实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/marshal-and-unmarshal/" class="chapter-link">
            <span class="chapter-title">第九章：序列化实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/log-component/" class="chapter-link">
            <span class="chapter-title">第十章：日志模块实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/connection-pool/" class="chapter-link">
            <span class="chapter-title">第十一章：连接池实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/interceptor/" class="chapter-link">
            <span class="chapter-title">第十二章：拦截器实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/component-interface/" class="chapter-link">
            <span class="chapter-title">第十三章：组件可插拔实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/plugin/" class="chapter-link">
            <span class="chapter-title">第十四章：插件体系实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/service-discovery-selection/" class="chapter-link">
            <span class="chapter-title">第十五章：服务发现原理及选型</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/service-discovery-implementation/" class="chapter-link">
            <span class="chapter-title">第十六章：服务发现实现 —— consul</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/load-balance-implementation/" class="chapter-link">
            <span class="chapter-title">第十七章：负载均衡实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/tracing-selection/" class="chapter-link">
            <span class="chapter-title">第十八章：分布式链路追踪原理及选型</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/tracing-implementation/" class="chapter-link">
            <span class="chapter-title">第十九章：分布式链路追踪实现 —— jaeger</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/auth/" class="chapter-link">
            <span class="chapter-title">第二十章：认证鉴权实现</span>
          </a>
        </li>
        <li class="chapter-item active">
          <a href="https://diu.life/lessons/go-rpc/code-generation/" class="chapter-link">
            <span class="chapter-title">第二十一章：代码生成工具实现</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/performance-test/" class="chapter-link">
            <span class="chapter-title">第二十二章：框架性能测试</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/performance-optimization/" class="chapter-link">
            <span class="chapter-title">第二十三章：框架性能优化</span>
          </a>
        </li>
        <li class="chapter-item ">
          <a href="https://diu.life/lessons/go-rpc/summary/" class="chapter-link">
            <span class="chapter-title">第二十四章：总结与展望</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  
  <div class="lesson-content">
    <article class="post-single">
      <header class="post-header">
        <h1 class="post-title">第二十一章：代码生成工具实现</h1>
        <div class="post-meta">
          <time datetime="2020-02-21T00:00:00&#43;08:00">2020-02-21</time>
        </div>
      </header>

      <div class="post-content">
        <p>前面我们说到了 gorpc 调用有反射和代码生成两种调用方式。前面的介绍一直都以反射的调用方式来进行介绍。下面我们先来介绍一下代码生成方式的调用全过程，接着介绍下代码生成工具的调研和具体实现。</p>
<h3 id="一以代码生成方式调用全过程">一、以代码生成方式调用全过程。</h3>
<ol>
<li>定义一个服务，这里使用 proto 文件的形式进行定义</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kn">package</span> <span class="nn">helloworld</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">service</span> <span class="n">Greeter</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="k">rpc</span> <span class="n">SayHello</span> <span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloReply</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">HelloRequest</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">HelloReply</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>  <span class="kt">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></div><ol>
<li>安装 protoc-gen-gorpc 代码生成工具，在终端执行（前提是需要已经安装 protoc 工具，详情可参考<a href="https://github.com/lubanproj/protoc-gen-gorpc">protoc-gen-go 安装</a>）</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">go get -v github.com/lubanproj/protoc-gen-gorpc
</span></span></code></pre></div><ol>
<li>执行</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">protoc --gorpc_out</span><span class="o">=</span><span class="s">plugin:. helloworld.proto</span>
</span></span></code></pre></div><p>测试会生成 helloworld.pb.go 文件，这个文件里面包括 server 的描述文件和 client 的 stub 代码。</p>
<h3 id="二代码生成的文件内容">二、代码生成的文件内容</h3>
<p>代码生成的文件内容主要有两块：</p>
<p>第一块主要是 server 服务信息，包括 GreeterService （服务的接口定义）、RegisterService（服务的注册函数）、 _Greeter_serviceDesc（服务名、方法名等描述信息） 、GreeterService_SayHello_Handler（方法的 Handler）等信息，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// This following code was generated by protoc-gen-gorpc, DO NOT EDIT!!!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">//================== server skeleton ===================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">type</span><span class="w"> </span><span class="nx">GreeterService</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="o">*</span><span class="nx">HelloRequest</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">HelloReply</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">var</span><span class="w"> </span><span class="nx">_Greeter_serviceDesc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">gorpc</span><span class="p">.</span><span class="nx">ServiceDesc</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">ServiceName</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;helloworld.Greeter&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">HandlerType</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">GreeterService</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">Methods</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">gorpc</span><span class="p">.</span><span class="nx">MethodDesc</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nx">MethodName</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;SayHello&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nx">Handler</span><span class="p">:</span><span class="w">    </span><span class="nx">GreeterService_SayHello_Handler</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">GreeterService_SayHello_Handler</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">svr</span><span class="w"> </span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="nx">dec</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="nx">ceps</span><span class="w"> </span><span class="p">[]</span><span class="nx">interceptor</span><span class="p">.</span><span class="nx">ServerInterceptor</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">req</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">HelloRequest</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ceps</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">svr</span><span class="p">.(</span><span class="nx">GreeterService</span><span class="p">).</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">handler</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">reqbody</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">svr</span><span class="p">.(</span><span class="nx">GreeterService</span><span class="p">).</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">reqbody</span><span class="p">.(</span><span class="o">*</span><span class="nx">HelloRequest</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">interceptor</span><span class="p">.</span><span class="nf">ServerIntercept</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">ceps</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">RegisterService</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">gorpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span><span class="w"> </span><span class="nx">svr</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">s</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">_Greeter_serviceDesc</span><span class="p">,</span><span class="w"> </span><span class="nx">svr</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>第二块主要包括 client 桩代码，主要生成了一个 proxy 代理 GreeterClientProxy ，以及代理的实现 GreeterClientProxyImpl，GreeterClientProxyImpl 实现了 GreeterClientProxy 接口定义的 SayHello 方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cp">//================== client stub===================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">//GreeterClientProxy is a client proxy for service Greeter.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">type</span><span class="w"> </span><span class="nx">GreeterClientProxy</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="o">*</span><span class="nx">HelloRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">client</span><span class="p">.</span><span class="nx">Option</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">HelloReply</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">type</span><span class="w"> </span><span class="nx">GreeterClientProxyImpl</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">client</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">opts</span><span class="w">   </span><span class="p">[]</span><span class="nx">client</span><span class="p">.</span><span class="nx">Option</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="nf">NewGreeterClientProxy</span><span class="p">(</span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">client</span><span class="p">.</span><span class="nx">Option</span><span class="p">)</span><span class="w"> </span><span class="nx">GreeterClientProxy</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">GreeterClientProxyImpl</span><span class="p">{</span><span class="nx">client</span><span class="p">:</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">DefaultClient</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="p">:</span><span class="w"> </span><span class="nx">opts</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// SayHello is server rpc method as defined</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">GreeterClientProxyImpl</span><span class="p">)</span><span class="w"> </span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="o">*</span><span class="nx">HelloRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="w"> </span><span class="o">...</span><span class="nx">client</span><span class="p">.</span><span class="nx">Option</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">HelloReply</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">callopts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">client</span><span class="p">.</span><span class="nx">Option</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">opts</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">callopts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">callopts</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="o">...</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">callopts</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">callopts</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="o">...</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">rsp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">HelloReply</span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;/helloworld.Greeter/SayHello&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">callopts</span><span class="o">...</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">rsp</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="三为什么需要代码生成">三、为什么需要代码生成？</h3>
<p>我们知道，server 收到 client 请求后，需要调用相应的 Handler 去处理，通过反射的方式去调用服务，Handler 里面的服务名、方法名等信息需要通过 reflect 包去动态获取，这个过程是有不小性能损耗的（下一章节会介绍）。假如不 care 这点性能损耗，又比较喜欢通过 go struct 的形式定义服务，当然可以采用这种方式。假如 care 性能损耗的话，就可以使用代码生成的方式，通过代码生成工具，将 proto 文件里面定义的 Service 生成相应的 server handler 和 client stub 代码。服务名、方法名、Handler 等信息提前静态生成好，就能避免反射带来的性能损耗。</p>
<h3 id="四代码生成工具实现思路">四、代码生成工具实现思路</h3>
<p>要基于 protoc 实现代码生成工具，首先需要去了解 protoc 代码生成的原理，如下图（图片来源于网络）：</p>
<p><img alt="img" loading="lazy" src="/images/go-rpc/21-1.jpg"></p>
<p>从上图可以看到，protoc 代码生成主要分为五个步骤，我们只需要关注第三个步骤——插件的实现即可。</p>
<p>protoc 工具为了支持 go 语言的代码生成，提供了 protoc-gen-go 插件，在执行 protoc 命令时加上 &ndash;go_out 这个选项，protoc 就会默认去找 protoc-gen-go 这个插件，既然是关注插件的实现，那么我们有两种方式可以做到：</p>
<h4 id="1模仿-grpc-的方式">1、模仿 grpc 的方式</h4>
<p>由于 grpc 和 protobuf 都是 google 的项目，google 默认在 protoc-gen-go 这个项目下有一个 grpc 目录去负责 grpc 的代码生成，参考：<a href="https://github.com/golang/protobuf/tree/master/protoc-gen-go">protoc-gen-go</a></p>
<p>使用 protoc 生成 grpc 的调用代码命令如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">protoc --go_out<span class="o">=</span><span class="nv">plugins</span><span class="o">=</span>grpc:. --go_opt<span class="o">=</span><span class="nv">paths</span><span class="o">=</span>source_relative helloworld/helloworld.proto
</span></span></code></pre></div><p>可以看到 protoc 也是使用 &ndash;go_out=plugins=grpc 这个参数选项，传入 plugins 这个参数，当发现 plugins 这个参数时，protoc 会去找实现了 Plugin 接口的插件， protoc-gen-go 项目的 grpc 包刚好实现了 Plugin 插件，所以就会执行 grpc.go 中的代码，生成 grpc 的调用代码 <a href="https://github.com/golang/protobuf/tree/master/protoc-gen-go/grpc">grpc.go</a></p>
<p>假如需要模仿 grpc，那么我们需要下载 protoc-gen-go 的包，然后建立一个与 grpc 同目录的包 gorpc，实现 Plugin 插件，代码生成时采用 protoc &ndash;go_out=plugins=gorpc:. 这种方式。</p>
<h4 id="2制作-protoc-gen-gorpc-插件">2、制作 protoc-gen-gorpc 插件</h4>
<p>第二种方式是使用 protoc &ndash;gorpc_out=:. 这个命令，这个命令会去你的系统 Path 路径去寻找 protoc-gen-gorpc 的 bin 文件去执行代码生成，相比于第一种方式而言，这种方式更加灵活。</p>
<p>考虑到灵活性，我们选择第二种方式进行代码生成。</p>
<h3 id="五代码生成工具实现细节">五、代码生成工具实现细节</h3>
<h4 id="1main-函数的编写">1、main 函数的编写</h4>
<p>main 函数的编写主要是实现了上图的第三个步骤，从 os.Stdin 中读取二进制数据，然后反序列化成 CodeGeneratorRequest 对象，然后解析 CodeGeneratorRequest ，根据需求构造 CodeGeneratorResponse 对象，将 CodeGeneratorResponse 对象序列化成二进制数据，通过 os.Stout 返回给 protoc 插件。这里的代码目前所有社区的 protoc 插件都可以通用，直接 copy 即可：<a href="https://github.com/lubanproj/protoc-gen-gorpc/blob/master/main.go">main.go</a></p>
<h4 id="2实现-plugin">2、实现 Plugin</h4>
<p>上面说到了，要根据 protoc 制作一个代码生成插件，需要实现 Plugin 接口，我们先来看看 Plugin 接口如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A Plugin provides functionality to add to the output during Go code generation,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// such as to produce RPC stubs.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">type</span><span class="w"> </span><span class="nx">Plugin</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// Name identifies the plugin.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nf">Name</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// Init is called once after data structures are built but before</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// code generation begins.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nf">Init</span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Generator</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// Generate produces the code generated by the plugin for this file,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// except for the imports, by calling the generator&#39;s methods P, In, and Out.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nf">Generate</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="o">*</span><span class="nx">FileDescriptor</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// GenerateImports produces the import declarations for this file.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// It is called after Generate.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nf">GenerateImports</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="o">*</span><span class="nx">FileDescriptor</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>我们主要是实现 Generate 方法即可，在 main.go 的 g.GenerateAllFiles() ——&gt; g.generate(file) ——&gt; g.runPlugins(file) 里面会去执行所有实现了 Plugin 接口插件的代码，主要是调用 Generate() 方法，如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run all the plugins associated with the file.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">g</span><span class="w"> </span><span class="o">*</span><span class="nx">Generator</span><span class="p">)</span><span class="w"> </span><span class="nf">runPlugins</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="o">*</span><span class="nx">FileDescriptor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">gorpclog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;plugins : %v&#34;</span><span class="p">,</span><span class="w"> </span><span class="nx">plugins</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">gorpclog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;len(plugins) : %d&#34;</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">plugins</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">plugins</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nx">p</span><span class="p">.</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="3实现-generate">3、实现 Generate</h4>
<p>gorpc 的 Generate 方法主要是生成 import 和针对每个 proto 文件定义的 Service，去生成具体 Service 代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Generate generates code for the services in the given file.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">gorpc</span><span class="p">)</span><span class="w"> </span><span class="nf">Generate</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="o">*</span><span class="nx">generator</span><span class="p">.</span><span class="nx">FileDescriptor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">FileDescriptorProto</span><span class="p">.</span><span class="nx">Service</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">gen</span><span class="p">.</span><span class="nf">AddImport</span><span class="p">(</span><span class="nx">gorpcServerPkgPath</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">gen</span><span class="p">.</span><span class="nf">AddImport</span><span class="p">(</span><span class="nx">gorpcClientPkgPath</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">gen</span><span class="p">.</span><span class="nf">AddImport</span><span class="p">(</span><span class="nx">gorpcInterceptorPkgPath</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">gen</span><span class="p">.</span><span class="nf">AddImport</span><span class="p">(</span><span class="s">&#34;context&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="c1">// generate all services</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">FileDescriptorProto</span><span class="p">.</span><span class="nx">Service</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateService</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="4实现-generateservice">4、实现 generateService</h4>
<p>下面这段代码实现了 gorpc 的所有需要的 server 代码 和 client stub 代码的生成，它的核心原理主要是调用 p.P 去生成静态代码，通过 generator.FileDescriptor 、pb.ServiceDescriptorProto 这两个对象，获得 proto 文件定义的服务信息，然后生成相应的静态代码，这里就不过多赘述，读者直接读源码即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// generateService generates all the code for the named service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">gorpc</span><span class="p">)</span><span class="w"> </span><span class="nf">generateService</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="o">*</span><span class="nx">generator</span><span class="p">.</span><span class="nx">FileDescriptor</span><span class="p">,</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ServiceDescriptorProto</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">originServiceName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nf">GetName</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">serviceName</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">upperFirstLatter</span><span class="p">(</span><span class="nx">originServiceName</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="s">&#34;// This following code was generated by protoc-gen-gorpc, DO NOT EDIT!!!&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="s">&#34;//================== server skeleton ===================&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">`type %sService interface {
</span></span></span><span class="line"><span class="cl"><span class="s">            `</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">Method</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateServerInterfaceCode</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="s">&#34;}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateServiceDesc</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nf">GetPackage</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">Method</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateServerCode</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nf">GetPackage</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateRegisterCode</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="s">&#34;//================== client stub===================&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">`//%sClientProxy is a client proxy for service %s.
</span></span></span><span class="line"><span class="cl"><span class="s">      type %sClientProxy interface {
</span></span></span><span class="line"><span class="cl"><span class="s">   `</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">Method</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateClientInterfaceCode</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="s">&#34;}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">`
</span></span></span><span class="line"><span class="cl"><span class="s">      type %sClientProxyImpl struct {
</span></span></span><span class="line"><span class="cl"><span class="s">         client client.Client
</span></span></span><span class="line"><span class="cl"><span class="s">         opts   []client.Option
</span></span></span><span class="line"><span class="cl"><span class="s">      }
</span></span></span><span class="line"><span class="cl"><span class="s">   `</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nx">p</span><span class="p">.</span><span class="nf">P</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">`
</span></span></span><span class="line"><span class="cl"><span class="s">      func New%sClientProxy(opts ...client.Option) %sClientProxy {
</span></span></span><span class="line"><span class="cl"><span class="s">         return &amp;%sClientProxyImpl{client: client.DefaultClient, opts: opts}
</span></span></span><span class="line"><span class="cl"><span class="s">      }
</span></span></span><span class="line"><span class="cl"><span class="s">   `</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceName</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">Method</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nx">p</span><span class="p">.</span><span class="nf">generateClientCode</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nf">GetPackage</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="六小结">六、小结</h3>
<p>本章节主要介绍了 gorpc 代码生成工具的原理和实现，源码详见：<a href="https://github.com/lubanproj/protoc-gen-gorpc">protoc-gen-gorpc</a></p>

      </div>

      
      <div class="lesson-navigation">
        
        <div class="nav-buttons">
            <a href="https://diu.life/lessons/go-rpc/auth/" class="nav-btn prev-btn">
              <span>← 上一章</span>
              <span class="nav-title">第二十章：认证鉴权实现</span>
            </a>
            <a href="https://diu.life/lessons/go-rpc/performance-test/" class="nav-btn next-btn">
              <span>下一章 →</span>
              <span class="nav-title">第二十二章：框架性能测试</span>
            </a>
        </div>
      </div>
    </article>
  </div>
</div>

<style>
 
.main {
  max-width: 100% !important;
  padding: 0 !important;
}

.lesson-container {
  display: flex;
  min-height: calc(100vh - 60px);
  gap: 0;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}

.lesson-sidebar {
  width: 320px;
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
  border-right: none;
  box-shadow: 2px 0 20px rgba(0, 0, 0, 0.08);
  position: sticky;
  top: 60px;
  height: calc(100vh - 60px);
  overflow-y: auto;
  padding: 30px 25px;
  z-index: 10;
}

.lesson-nav h3 {
  margin: 0 0 30px 0;
  color: #2c3e50;
  font-size: 1.4em;
  font-weight: 700;
  text-align: center;
  padding-bottom: 15px;
  border-bottom: 2px solid #e3f2fd;
  position: relative;
}

.lesson-nav h3::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.chapter-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.chapter-item {
  margin-bottom: 12px;
}

.chapter-link {
  display: block;
  padding: 16px 20px;
  color: #5a6c7d;
  text-decoration: none;
  border-radius: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid transparent;
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(10px);
  position: relative;
  overflow: hidden;
}

.chapter-link::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transition: left 0.5s;
}

.chapter-link:hover {
  background: rgba(255, 255, 255, 0.9);
  color: #2c3e50;
  transform: translateX(8px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.chapter-link:hover::before {
  left: 100%;
}

.chapter-item.active .chapter-link {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #ffffff;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
  transform: translateX(8px);
}

.chapter-item.active .chapter-link::before {
  display: none;
}

.chapter-title {
  font-size: 0.95em;
  line-height: 1.5;
  font-weight: 500;
}

.lesson-content {
  flex: 1;
  padding: 40px 50px;
  width: 100%;
  overflow-x: auto;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  margin: 20px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
  position: relative;
}

.lesson-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px 20px 0 0;
}

.post-single {
  max-width: 100%;
  margin: 0;
}

.post-header {
  margin-bottom: 40px;
  padding-bottom: 20px;
  border-bottom: 1px solid #e8ecef;
}

.post-title {
  font-size: 2.2em;
  font-weight: 800;
  margin: 0 0 15px 0;
  color: #2c3e50;
  line-height: 1.3;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.post-meta {
  color: #7f8c8d;
  font-size: 0.95em;
  font-weight: 500;
}

.post-content {
  line-height: 1.8;
  color: #34495e;
  font-size: 1.05em;
}

.post-content h2 {
  margin-top: 50px;
  margin-bottom: 25px;
  font-size: 1.6em;
  font-weight: 700;
  color: #2c3e50;
  position: relative;
  padding-left: 20px;
}

.post-content h2::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 60%;
  background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
  border-radius: 2px;
}

.post-content h3 {
  margin-top: 35px;
  margin-bottom: 20px;
  font-size: 1.4em;
  font-weight: 600;
  color: #2c3e50;
}

.post-content p {
  margin-bottom: 20px;
  text-align: justify;
}

.post-content ul, .post-content ol {
  margin-bottom: 20px;
  padding-left: 25px;
}

.post-content li {
  margin-bottom: 10px;
  line-height: 1.7;
}

.post-content code {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.9em;
  color: #e83e8c;
  font-weight: 500;
  border: 1px solid #dee2e6;
}

.post-content pre {
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  padding: 25px;
  border-radius: 12px;
  overflow-x: auto;
  margin: 30px 0;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  border: 1px solid #4a5568;
}

.post-content pre code {
  background: none;
  padding: 0;
  border-radius: 0;
  color: #a0aec0;
  border: none;
}

.lesson-navigation {
  margin-top: 60px;
  padding-top: 40px;
  border-top: 2px solid #e8ecef;
  position: relative;
}

.lesson-navigation::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 2px;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.nav-buttons {
  display: flex;
  justify-content: space-between;
  gap: 25px;
}

.nav-btn {
  display: flex;
  flex-direction: column;
  padding: 20px 25px;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border: 2px solid #e9ecef;
  border-radius: 15px;
  text-decoration: none;
  color: #2c3e50;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  flex: 1;
  max-width: 320px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
}

.nav-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
  transition: left 0.6s;
}

.nav-btn:hover {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
  color: #ffffff;
  transform: translateY(-3px);
  box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
}

.nav-btn:hover::before {
  left: 100%;
}

.nav-btn span:first-child {
  font-size: 0.95em;
  color: #7f8c8d;
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.nav-btn:hover span:first-child {
  color: rgba(255, 255, 255, 0.9);
}

.nav-title {
  font-weight: 600;
  line-height: 1.4;
  font-size: 1.05em;
}

.next-btn {
  text-align: right;
}

@media (max-width: 768px) {
  .lesson-container {
    flex-direction: column;
    background: linear-gradient(180deg, #f5f7fa 0%, #c3cfe2 100%);
  }
  
  .lesson-sidebar {
    width: 100%;
    height: auto;
    position: static;
    border-right: none;
    border-bottom: 2px solid #e8ecef;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    padding: 25px 20px;
    margin: 0;
    border-radius: 0;
  }
  
  .lesson-content {
    max-width: 100%;
    padding: 30px 20px;
    margin: 15px;
    border-radius: 15px;
  }
  
  .post-title {
    font-size: 1.8em;
  }
  
  .post-content {
    font-size: 1em;
  }
  
  .nav-buttons {
    flex-direction: column;
    gap: 15px;
  }
  
  .nav-btn {
    max-width: 100%;
  }
  
  .next-btn {
    text-align: left;
  }
  
  .chapter-link:hover,
  .chapter-item.active .chapter-link {
    transform: none;
  }
}
</style>
    </main>
    
<footer class="footer">
    <div class="footer-content">
        <div class="footer-copyright">
                <span>&copy; 2024 丢哥 all rights reserved.</span>
        </div>
        <div class="footer-links">
            <a href="/privacy-policy/" title="隐私政策">隐私政策</a> |
            <a href="/terms-of-service/" title="服务条款">服务条款</a>
        </div>
    </div>

</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script></body>

</html>
